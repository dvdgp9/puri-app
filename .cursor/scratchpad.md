# Proyecto: Sistema de Gesti√≥n en Masa con Modal para Puri

## Background and Motivation

### Contexto Actual
El sistema Puri actual funciona con un flujo lineal:
- Los centros ya existen en BD (creados manualmente)
- Navegaci√≥n: Centro ‚Üí Instalaciones (CRUD individual) ‚Üí Actividades (CRUD individual) ‚Üí CSV individual por actividad
- Cada creaci√≥n requiere m√∫ltiples p√°ginas y formularios separados

### Propuesta de Mejora
El usuario solicita implementar:
1. **Creaci√≥n manual de centros por admin** - Nueva funcionalidad admin
2. **Modal "Gestionar Centro"** que permita operaciones en masa:
   - Crear m√∫ltiples instalaciones de una vez
   - Crear m√∫ltiples actividades por instalaci√≥n
   - Asignar archivos CSV a cada actividad creada
3. **Experiencia unificada** - Todo en un solo modal intuitivo

### Beneficios Esperados
- **Eficiencia**: Reducir tiempo de setup de nuevos centros de horas a minutos
- **UX**: Interfaz m√°s moderna y fluida con modal responsivo
- **Escalabilidad**: Facilitar la gesti√≥n de centros con muchas instalaciones/actividades
- **Administraci√≥n**: Crear un rol de administrador para gesti√≥n global de centros

## Key Challenges and Analysis

### Desaf√≠os T√©cnicos
1. **Arquitectura Modal**: Implementar modal complejo con m√∫ltiples pasos/pesta√±as
2. **Gesti√≥n de Estados**: Mantener estado del modal durante creaciones m√∫ltiples
3. **Validaci√≥n Masiva**: Validar m√∫ltiples entidades antes de persistir en BD
4. **Transacciones**: Asegurar consistencia en operaciones masivas (rollback si falla alguna)
5. **Upload M√∫ltiple**: Manejar m√∫ltiples archivos CSV y asociarlos correctamente
6. **UI/UX Compleja**: Crear interfaz intuitiva para operaciones complejas
7. **Estructura de Horarios**: Implementar nueva estructura para actividades que se realizan varias veces por semana
8. **Migraci√≥n de Datos**: Convertir horarios existentes de texto plano a estructura nueva
9. **Compatibilidad**: Mantener funcionalidad existente durante la transici√≥n

### Desaf√≠os de Seguridad
1. **Autenticaci√≥n Admin**: Implementar rol de administrador seguro
2. **Validaci√≥n de Archivos**: Verificar integridad y formato de m√∫ltiples CSVs
3. **L√≠mites de Upload**: Controlar tama√±o y cantidad de archivos subidos
4. **CSRF Protection**: Proteger formularios complejos

### Consideraciones de Performance
1. **Procesamiento As√≠ncrono**: Para operaciones masivas que pueden tomar tiempo
2. **Progress Indicators**: Mostrar progreso en tiempo real
3. **Memoria**: Optimizar para manejar m√∫ltiples archivos CSV grandes
4. **Timeouts**: Evitar timeouts en operaciones largas

## High-level Task Breakdown

### Phase 1: An√°lisis y Dise√±o (Planner)
1. **An√°lisis de Viabilidad T√©cnica**
   - Evaluar compatibilidad con arquitectura actual
   - Identificar dependencias y librer√≠as necesarias
   - Definir especificaciones t√©cnicas detalladas
   - **Success Criteria**: Documento t√©cnico con arquitectura propuesta

2. **Dise√±o de UX/UI del Modal**
   - Wireframes del modal multi-paso
   - Flujo de usuario para creaci√≥n masiva
   - Dise√±o responsive para m√≥vil y desktop
   - **Success Criteria**: Mockups interactivos del modal completo

3. **Dise√±o de Base de Datos**
   - Esquema para roles de administrador
   - Optimizaciones para operaciones masivas
   - √çndices y constraints necesarios
   - **Success Criteria**: DDL scripts y diagrama ER actualizado

4. **Dise√±o de Estructura de Horarios**
   - Nueva estructura para almacenar horarios de actividades
   - Soporte para m√∫ltiples sesiones por semana
   - Estrategia de migraci√≥n de datos existentes
   - **Success Criteria**: DDL para nuevos campos y script de migraci√≥n

### Phase 2: Implementaci√≥n Core (Executor)
4. **Sistema de Administrador**
   - Crear tabla `admins` y sistema de autenticaci√≥n
   - Implementar p√°ginas de admin para gesti√≥n de centros
   - Middleware de autorizaci√≥n para rutas admin
   - **Success Criteria**: Admin puede crear/editar/eliminar centros

5. **Modal Framework Base**
   - Estructura HTML/CSS del modal responsivo
   - Sistema de pasos/tabs navegables
   - Estados de loading y validaci√≥n
   - **Success Criteria**: Modal vac√≠o funcionando con navegaci√≥n

6. **API Endpoints para Operaciones Masivas**
   - `POST /api/centros/crear` - Crear centro
   - `POST /api/instalaciones/crear-masivo` - Crear m√∫ltiples instalaciones
   - `POST /api/actividades/crear-masivo` - Crear m√∫ltiples actividades
   - `POST /api/actividades/upload-csv-masivo` - Upload m√∫ltiples CSVs
   - **Success Criteria**: APIs funcionando con validaci√≥n y manejo de errores

### Phase 3: Funcionalidad del Modal (Executor)
7. **Paso 1: Creaci√≥n de Instalaciones**
   - Formulario din√°mico para agregar/quitar instalaciones
   - Validaci√≥n en tiempo real
   - Preview de instalaciones a crear
   - **Success Criteria**: Se pueden crear m√∫ltiples instalaciones desde el modal

8. **Paso 2: Creaci√≥n de Actividades**
   - Selector de instalaci√≥n y formulario de actividades
   - Campos: nombre, horario, fechas inicio/fin
   - Validaci√≥n de fechas y horarios
   - **Success Criteria**: Se pueden crear m√∫ltiples actividades por instalaci√≥n

9. **Paso 3: Upload de CSVs**
   - Drag & drop para m√∫ltiples archivos
   - Asociaci√≥n archivo-actividad con preview
   - Validaci√≥n de formato CSV
   - **Success Criteria**: CSVs se asocian correctamente a actividades

### Phase 4: Integraci√≥n y Testing (Executor)
10. **Integraci√≥n Completa**
    - Unir todos los pasos en flujo completo
    - Transacciones atomicas para todo el proceso
    - Manejo de errores con rollback completo
    - **Success Criteria**: Flujo completo funciona end-to-end

11. **UI/UX Polish**
    - Animaciones y transiciones suaves
    - Indicadores de progreso detallados
    - Mensajes de √©xito/error informativos
    - **Success Criteria**: Experiencia de usuario pulida y profesional

12. **Testing y Bug Fixes**
    - Tests de casos edge (archivos corruptos, timeouts, etc.)
    - Verificaci√≥n en diferentes dispositivos
    - Performance testing con datos masivos
    - **Success Criteria**: Sistema robusto y sin bugs cr√≠ticos

## Project Status Board

### Phase 1: An√°lisis y Dise√±o
- [ ] **Task 1**: An√°lisis de Viabilidad T√©cnica
- [ ] **Task 2**: Dise√±o de UX/UI del Modal  
- [ ] **Task 3**: Dise√±o de Base de Datos
- [ ] **Task 4**: Dise√±o de Estructura de Horarios

### Phase 2: Implementaci√≥n Core
- [ ] **Task 4**: Sistema de Administrador
- [ ] **Task 5**: Modal Framework Base
- [ ] **Task 6**: API Endpoints para Operaciones Masivas

### Phase 3: Funcionalidad del Modal
- [ ] **Task 7**: Paso 1 - Creaci√≥n de Instalaciones
- [ ] **Task 8**: Paso 2 - Creaci√≥n de Actividades  
- [ ] **Task 9**: Paso 3 - Upload de CSVs

### Phase 4: Integraci√≥n y Testing
- [ ] **Task 10**: Integraci√≥n Completa
- [ ] **Task 11**: UI/UX Polish
- [ ] **Task 12**: Testing y Bug Fixes

## Current Status / Progress Tracking

**Status**: üìã PLANNING PHASE - Task 1 Completed ‚úÖ
**Current Phase**: Modo Planner - An√°lisis de viabilidad completado, iniciando dise√±o UX/UI  
**Next Action**: Task 2 - Dise√±o de UX/UI del Modal

### Task 1 Results ‚úÖ - An√°lisis de Viabilidad T√©cnica:

#### ‚úÖ COMPLETAMENTE VIABLE - Arquitectura Compatible
- **Sistema de Modales Existente**: Ya implementado con `modal-backdrop`, `modal`, transiciones CSS y JavaScript
- **Patr√≥n JavaScript**: Funciones consistentes `showModal()`, `hideModal()`, `showOptionsModal()` reutilizables
- **CSS Framework**: Variables CSS organizadas, sistema responsive, componentes modulares
- **Upload CSV**: `procesar_excel.php` ya maneja CSV con validaci√≥n, transacciones y rollback

#### ‚úÖ Especificaciones T√©cnicas Definidas
**Modal Multi-Paso Architecture:**
- **Base**: Extender `.modal-backdrop` y `.modal` existentes

**Estructura de Horarios:**
- **Campos nuevos**: `dias_semana` (SET), `hora_inicio` (TIME), `hora_fin` (TIME)
- **Compatibilidad**: Mantener campo `horario` existente durante transici√≥n
- **Migraci√≥n**: Script para convertir texto plano a estructura nueva
- **UI**: Selectores de d√≠as (checkboxes) y horas (time inputs)
- **Navegaci√≥n**: Sistema de tabs/steps con JavaScript vanilla (consistente con el sistema actual)
- **Estados**: Loading, validation, success/error con indicadores visuales
- **Responsive**: Ya implementado en CSS actual, funciona en m√≥vil y desktop

**Backend APIs Necesarias:**
```php
// Nuevos endpoints para operaciones masivas
POST /api/admin/centros/crear
POST /api/instalaciones/crear-masivo  
POST /api/actividades/crear-masivo
POST /api/upload/csv-multiple
```

**Base de Datos:**
- **Nueva tabla**: `admins` (id, username, password_hash, created_at)
- **Modificar**: Agregar session handling para admin
- **Usar**: Transacciones PDO existentes para atomicidad

#### ‚úÖ Dependencias y Librer√≠as Identificadas
**NO se necesitan librer√≠as adicionales:**
- ‚úÖ **Modal System**: Ya implementado en CSS/JS vanilla
- ‚úÖ **File Upload**: `$_FILES` PHP nativo + validaci√≥n existente
- ‚úÖ **Form Validation**: Funciones de sanitizaci√≥n ya implementadas
- ‚úÖ **Database**: PDO con prepared statements ya configurado
- ‚úÖ **UI Components**: Sistema de botones, formularios, responsive ya funcional

**Opcional (mejoras futuras):**
- Progress bars con CSS animations
- Drag & drop con HTML5 File API
- AJAX con fetch() API nativo

### An√°lisis Inicial Completado
- ‚úÖ **Sistema Actual Entendido**: Arquitectura PHP tradicional con MySQL
- ‚úÖ **Flujo Actual Mapeado**: Centro ‚Üí Instalaci√≥n ‚Üí Actividad ‚Üí CSV

### Dise√±o de Estructura de Horarios

#### Requisitos
- Soportar actividades que se realizan m√∫ltiples veces por semana
- Permitir filtrado y ordenamiento por d√≠as y horas
- Mantener compatibilidad con datos existentes
- Facilitar la migraci√≥n de datos

#### Propuesta de Estructura
```sql
-- Campos adicionales para horarios estructurados
ALTER TABLE actividades 
ADD COLUMN dias_semana SET('Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo') NULL,
ADD COLUMN hora_inicio TIME NULL,
ADD COLUMN hora_fin TIME NULL;
```

#### Estrategia de Migraci√≥n
1. **Fase 1**: A√±adir nuevos campos manteniendo el campo `horario` existente
2. **Fase 2**: Crear script de migraci√≥n para convertir texto a estructura nueva
3. **Fase 3**: Actualizar interfaces para usar nuevos campos
4. **Fase 4**: Opcionalmente, eliminar campo `horario` en versi√≥n futura

#### Consideraciones T√©cnicas
- Usar tipo SET para `dias_semana` para permitir m√∫ltiples selecciones
- Usar tipo TIME para `hora_inicio` y `hora_fin` para facilitar operaciones
- Mantener el campo `horario` durante transici√≥n para compatibilidad
- Crear funciones para convertir entre formatos

#### UI/UX para Horarios
- **Selector de d√≠as**: Checkboxes para seleccionar m√∫ltiples d√≠as
- **Selectores de hora**: Inputs tipo time para hora inicio/fin
- **Validaci√≥n**: Asegurar que hora fin > hora inicio
- **Visualizaci√≥n**: Mostrar horario de forma clara en listados
- ‚úÖ **Tecnolog√≠as Identificadas**: PHP + PDO, CSS personalizado, JavaScript vanilla
- ‚úÖ **Puntos de Integraci√≥n**: Modal se integrar√° en p√°gina principal de instalaciones
- ‚úÖ **Viabilidad Confirmada**: 100% compatible con arquitectura actual

## Executor's Feedback or Assistance Requests

### Informaci√≥n Adicional Necesaria del Usuario:
1. **Rol de Admin**: ¬øDebe ser un usuario completamente separado o un flag en la tabla de centros?
2. **L√≠mites**: ¬øCu√°ntas instalaciones/actividades m√°ximo se pueden crear de una vez?
3. **Archivos CSV**: ¬øDebe validarse el contenido antes de asociar o solo al procesar?
4. **Compatibilidad**: ¬øDebe funcionar en alg√∫n navegador espec√≠fico o solo modernos?

### Riesgos Identificados:
1. **Complejidad del Modal**: Puede ser abrumador para usuarios no t√©cnicos
2. **Performance**: Operaciones masivas pueden causar timeouts
3. **Memoria**: M√∫ltiples CSVs grandes pueden exceder l√≠mites PHP

## Lessons

### Aprendizajes del Sistema Actual:
- Sistema usa PDO con prepared statements (buena base de seguridad)
- CSS personalizado bien estructurado (f√°cil de extender)
- JavaScript vanilla con modales existentes (patr√≥n ya establecido)
- Validaci√≥n robusta en backend (reutilizable para operaciones masivas)

### Lecciones para el Desarrollo:
- Mantener consistencia con patrones existentes del sistema
- Usar las funciones de validaci√≥n y sanitizaci√≥n ya implementadas
- Aprovechar el sistema de modales existente como base
- Implementar gradualmente para evitar romper funcionalidad actual
- Considerar siempre la compatibilidad hacia atr√°s en cambios estructurales
- Planificar migraciones de datos como parte integral del desarrollo